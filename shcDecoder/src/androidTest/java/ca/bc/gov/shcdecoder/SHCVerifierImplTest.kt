package ca.bc.gov.shcdecoder

import android.content.Context
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.platform.app.InstrumentationRegistry
import ca.bc.gov.shcdecoder.model.ImmunizationRecord
import ca.bc.gov.shcdecoder.model.ImmunizationStatus
import kotlinx.coroutines.runBlocking
import org.junit.Assert
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class SHCVerifierImplTest {

    private lateinit var sut: SHCVerifierImpl

    private val context: Context = InstrumentationRegistry.getInstrumentation().targetContext

    private val testRecord = ImmunizationRecord(
        name = DEFAULT_NAME,
        birthDate = DEFAULT_BIRTHDATE,
        status = ImmunizationStatus.INVALID_QR_CODE
    )

    private val config = SHCConfig(
        "https://phsasmarthealthcard-dev.azurewebsites.net/v1/trusted/.well-known/issuers.json",
        "https://ds9mwekyyprcy.cloudfront.net/rules.json",
        "pvc.service.yukon.ca",
        emptyList(),
        emptyList(),
        120000L
    )

    @Before
    fun setUp() {
        sut = SHCVerifierImpl(context, config)
    }

    @Test
    fun givenValidSignatureCalled_whenSignatureIsValid_thenReturnsTrue(): Unit = runBlocking {
        val result = sut.hasValidSignature(VALID_FULLY_IMMUNIZED_SHC_URI)
        Assert.assertEquals(result, true)
    }

    @Test(expected = SHCDecoderException::class)
    fun givenHasValidateSignatureCalled_whenSignatureIsForged_thenThrowsSHCDecoderException(): Unit = runBlocking {
        sut.hasValidSignature(FORGED_SHC_URI)
    }

    @Test
    fun givenGetImmunizationRecord_whenUserFullyVaccinated_thenShowsFullyImmunized(): Unit = runBlocking {
        val result = sut.getImmunizationRecord(VALID_FULLY_IMMUNIZED_SHC_URI)
        Assert.assertEquals(result, testRecord.copy(
            status = ImmunizationStatus.FULLY_IMMUNIZED
        ))
    }

    @Test
    fun givenGetImmunizationRecord_whenUserPartiallyVaccinated_thenShowsPartiallyImmunized(): Unit = runBlocking {
        val result = sut.getImmunizationRecord(VALID_PARTIALLY_IMMUNIZED_SHC_URI)
        Assert.assertEquals(result, testRecord.copy(
            status = ImmunizationStatus.PARTIALLY_IMMUNIZED
        ))
    }

    @Test
    fun givenGetImmunizationRecord_whenUserNotVaccinated_thenShowsInvalidQrCode(): Unit = runBlocking {
        val result = sut.getImmunizationRecord(VALID_NO_VACCINES_SHC_URI)
        Assert.assertEquals(result, testRecord)
    }

    @Test
    fun givenGetImmunizationRecord_whenUserHasExempt_thenShowsFullyImmunized(): Unit = runBlocking {
        val result = sut.getImmunizationRecord(VALID_EXEMPT_SHC_URI)
        Assert.assertEquals(result, testRecord.copy(
            status = ImmunizationStatus.FULLY_IMMUNIZED
        ))
    }

    companion object {
        private const val VALID_FULLY_IMMUNIZED_SHC_URI = "shc:/5676290952432060346029243740446031222959532654603460292540772804336028702864716745222809286133314564376531415906402203064504590856435503414245413640370636654171372412363803043756220467374075323239254334433260573601104128125312707425357469745673363745252404076371614204366629033029240527745835041226387507445520406869553635001261102939672426386742702531683972107103555636000553682438630372754325762839456421225824680926317036044040334408766112280634102908097663033508055022776568664444323766396827723059290960005076242528060670383469440844625306597406080565236929557576676121686311763064555721522853413832057032032035394162660831095668595024324562685605407376405762620725761077322156726303505623533936632330557558035609645606230940550560583566712652046675325607200054624540276953120977442027576340760726277761352043617033112163636709225860615530702104547239557667624275681131340321337229401242302404502964203924456342566307284339253505692043757266413557505752657577337429441105543709272661302824364559772043444367336255314161372937425769586465623272625345063774672724286254066609572656554372433410076940563725404000220745742654645320660408226035264025097474047253307130743126370739047541684050300443666976245254703427563158455034676821716361706631324556043924272971110753116933256055270845317137665554761257117535566373094064503553724100103569397228557110751268566125500930572535057250325660564006395374016252660645212843592075501033007006357640103269773827707035385327442245370076773240693939123468412500574144555039656944755544436943343838565225521200377400760061653506263374"
        private const val VALID_PARTIALLY_IMMUNIZED_SHC_URI = "shc:/567629095243206034602924374044603122295953265460346029254077280433602870286471674522280928613331456437653141590640220306450459085643550341424541364037063665417137241236380304375622046737407532323925433443326057360157413131537170742435764144277366374525247407637127557258362770686223361225230836043267607407552140686955363550564355662903603033742072676455644528375021713903030765666763667069705262310323252220033330001259404152706456412076552371034537117423691211562860633264323121407430646255287577042211003445253003325240216703632076331007105338080836097750071038046612345045553156733663405771305505322205202142743608560333315561007533414462731266323212597058092338773172593862750954573771544545207663114233365629577174506327544407237659712352605465332220543038326761114511220744203950766429702339085943596975382700203776037229293725677138201272352450540936625533505925346639713930635239446373452628217041654163104258215733547326672173260659111200121070003432692327582808453174353321543662037559772443457332222557063838410358075000600935405310395367546175423332523212355900087032307338590406256541553755084252236038583259324212376607766900700931772569713872120441400936415957534042334306696352607344550938360950402631290831726734050835764467273142652936233103352562340530254376584204063472093308350750114535007762500950544212352577542363281240327353733453082374012232584224575741387521106807567561242872773174315006506663583276435411444068633032333176114232432125606962427304111209067403706331243964354230376843456124273730561158392920"
        private const val VALID_NO_VACCINES_SHC_URI = "shc:/56762909524320603460292437404460312229595326546034602925407728043360287028647167452228092861333145643765314159064022030645045908564355034142454136403706366541713724123638030437562204673740753232392543344332605736015745233139703274242443504555606452417425403175244353266875263423706522543842047410326835363065761007752976746874732965757342576400583805260722776408694164057342412043662428222360732436002769557640631138342710355567761121614072503373664536645541232029282657282107352235776375753726075233224452286870775554315440682500390942095727324165123052290512630059552935724236337120552961617745684437083812076676086740266757037700672008273468763059657554735472055508580463205263107724750050040757753665343420553244365355642421735861453837763272532926752954503174607452430721537661343436656237406131592075526232110531661154521165713562271007412552265530044263307321407520045977420903683759576472450667572024014441770629313629365937275709424421246268533510126304652966724211543645055030347337745276224153731176084021065906056428720962693003256064227500661250286258652734337459435958"

        private const val VALID_EXEMPT_SHC_URI = "shc:/56762909524320603460292437404460312229595326546034602925407728043360287028647167452228092861333145643765314159064022030645045908564355034142454136403706366541713724123638030437562204673740753232392543344332605736015745292139073320242843507606606374235266304057713838116441593361342277314031455555677355215442265000077069556723313824597011751011100921355660765967775545227653431033252666250323652966733300083524633003573335744205043759064325630677445677427540290429403936221161060728545536731000300628717110082169657439210905103459387740292368507710457167054243127531667611052271353160600558602421446925211076554177410508360021226753683712375672223974084565325232503231674352546959522627522475652152096400272111243704753621606376340536592053445837612972413568753867680033276530394311252656326574602712333862564470272412083037430974332627604273526674744457722444663768286829372473723611265327265377632926330775615523442272757759067259302763275406084470046459372111626777405931335543623603006704043364337760351054645070567125103323054064201155257261095570623540710971313042522932680525727243317575030060233010741277666062662325263450382154604323456422567771632464592567325531042336017069754036310773053650686574455322345809265223401277774326597755776921082725103708104137403403222111062924073072562842077058767710273807542827227377615861103932356140597674"

        private const val FORGED_SHC_URI = "shc:/56762909524320603460292437404460312229595326546034602925407728043360287028647167452228092864592145623604446237753604594353235808547745523439213738052572314155433343216655244166454345374563547738625928530570605736011041293339127474253574690935433638116043717275726160042258593238632109683539587331757043570338056200074208535006345370584258246561623800052964453377350520086009595266074275383170607777553631385609605822092706414553413428665522715570765238712812501271721056670960262659284424526627223572566635690837352952723322374030253128125550346475340707454569003462046634375703383604697429372373306763612329582503042920294068605366570825263030637167357261677635345940700361747142220056575904326676596034280355273331715321003435082961272422692530705565352020710056326923746612550367216177766808742161087043593011082373324545283864580761364069245665337007543871273269272130052428335934656860406535595459225939694543095225107558646728433137377342106111711257000926582671723928373353773625322235665874003162280638703025301272252861380323575377263536337129700803590010743567071235593400734032694172641143343276005323325455220023325923295736447776351170536809632967426371086124112809760069286854731242767632125805692123607760070543747009635368580629457764407144632176694342520626753744312072056409621008422850415024295003613572653529065560550631392253776563615673254104002535065637573452676911010775652822295510532145290064614069694024563806680665450807314235442506680539036443730704063500597750577067210422374027111156692634087223533457680612675345723309006968224574"

        private const val DEFAULT_NAME = "Jane Doe"
        private const val DEFAULT_BIRTHDATE = "1970-01-01"
    }
}